#!/usr/bin/env python3
"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                          â•‘
â•‘                    ğŸš€ SmartPOS CRM - Professional CLI Tool               â•‘
â•‘                                                                          â•‘
â•‘              Barcha funksiyalar bitta professional tool da               â•‘
â•‘                                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""

import os
import sys
import subprocess
import time
import signal
import platform
import argparse
import json
from pathlib import Path
from datetime import datetime

# ============================================================================
# RANGLAR VA STILLAR
# ============================================================================

class Colors:
    """ANSI rang kodlari"""
    # Asosiy ranglar
    BLACK = '\033[30m'
    RED = '\033[31m'
    GREEN = '\033[32m'
    YELLOW = '\033[33m'
    BLUE = '\033[34m'
    MAGENTA = '\033[35m'
    CYAN = '\033[36m'
    WHITE = '\033[37m'
    
    # Qalin ranglar
    BOLD = '\033[1m'
    DIM = '\033[2m'
    
    # Background ranglar
    BG_RED = '\033[41m'
    BG_GREEN = '\033[42m'
    BG_YELLOW = '\033[43m'
    BG_BLUE = '\033[44m'
    BG_CYAN = '\033[46m'
    
    # Reset
    RESET = '\033[0m'
    NC = '\033[0m'

class Style:
    """Chiroyli stillar"""
    @staticmethod
    def header(text):
        return f"{Colors.CYAN}{Colors.BOLD}{'â•' * 70}\n{text.center(70)}\n{'â•' * 70}{Colors.RESET}"
    
    @staticmethod
    def success(text):
        return f"{Colors.GREEN}âœ“{Colors.RESET} {Colors.GREEN}{text}{Colors.RESET}"
    
    @staticmethod
    def error(text):
        return f"{Colors.RED}âœ—{Colors.RESET} {Colors.RED}{text}{Colors.RESET}"
    
    @staticmethod
    def warning(text):
        return f"{Colors.YELLOW}âš {Colors.RESET} {Colors.YELLOW}{text}{Colors.RESET}"
    
    @staticmethod
    def info(text):
        return f"{Colors.BLUE}â„¹{Colors.RESET} {Colors.BLUE}{text}{Colors.RESET}"
    
    @staticmethod
    def step(text):
        return f"{Colors.CYAN}â–¶{Colors.RESET} {Colors.CYAN}{text}{Colors.RESET}"
    
    @staticmethod
    def box(text, color=Colors.CYAN):
        lines = text.split('\n')
        max_len = max(len(line) for line in lines) + 4
        box = f"{color}{'â•”' + 'â•' * (max_len - 2) + 'â•—'}{Colors.RESET}\n"
        for line in lines:
            box += f"{color}â•‘{Colors.RESET} {line.ljust(max_len - 4)} {color}â•‘{Colors.RESET}\n"
        box += f"{color}{'â•š' + 'â•' * (max_len - 2) + 'â•'}{Colors.RESET}"
        return box

# ============================================================================
# LOGO VA BANNER                                                             
# ============================================================================

def print_logo():
    """Professional logo chiqarish"""
    logo = f"""
{Colors.CYAN}{Colors.BOLD}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                          â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â•‘
â•‘   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•  â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â•‘
â•‘   â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â•â•â–ˆâ–ˆâ•‘  â•‘
â•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘        â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â•‘
â•‘   â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•        â•šâ•â•   â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•  â•‘
â•‘                                                                          â•‘
â•‘                    Professional CLI Management Tool                      â•‘
â•‘                         Version 1.0.0 | 2025                             â•‘
â•‘                                                                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{Colors.RESET}
"""
    print(logo)

def print_banner(text, color=Colors.CYAN):
    """Banner chiqarish"""
    print(f"\n{color}{Colors.BOLD}{'â•' * 70}")
    print(f"{text.center(70)}")
    print(f"{'â•' * 70}{Colors.RESET}\n")

# ============================================================================
# UTILITY FUNCTIONS
# ============================================================================

def check_command(cmd, name):
    """Command mavjudligini tekshirish"""
    try:
        if platform.system() == 'Windows':
            result = subprocess.run(['where', cmd], capture_output=True, text=True)
        else:
            result = subprocess.run(['which', cmd], capture_output=True, text=True)
        
        if result.returncode == 0:
            try:
                version = subprocess.run([cmd, '--version'], capture_output=True, text=True, timeout=2)
                version_text = version.stdout.split()[0] if version.stdout else 'N/A'
            except:
                version_text = 'N/A'
            print(Style.success(f"{name}: {version_text}"))
            return True
        else:
            print(Style.error(f"{name} topilmadi! Iltimos, o'rnating."))
            return False
    except Exception as e:
        print(Style.error(f"{name} tekshirishda xatolik: {e}"))
        return False

def run_command(cmd, cwd=None, background=False, log_file=None, silent=False, env=None):
    """Commandni ishga tushirish"""
    try:
        if background:
            if log_file:
                with open(log_file, 'w') as f:
                    process = subprocess.Popen(
                        cmd if isinstance(cmd, list) else cmd.split(),
                        shell=isinstance(cmd, str),
                        cwd=cwd,
                        env=env,
                        stdout=f,
                        stderr=subprocess.STDOUT,
                        start_new_session=True if platform.system() != 'Windows' else False,
                        creationflags=subprocess.CREATE_NEW_PROCESS_GROUP if platform.system() == 'Windows' else 0
                    )
            else:
                process = subprocess.Popen(
                    cmd if isinstance(cmd, list) else cmd.split(),
                    shell=isinstance(cmd, str),
                    cwd=cwd,
                    env=env,
                    stdout=subprocess.DEVNULL,
                    stderr=subprocess.DEVNULL,
                    start_new_session=True if platform.system() != 'Windows' else False,
                    creationflags=subprocess.CREATE_NEW_PROCESS_GROUP if platform.system() == 'Windows' else 0
                )
            return process
        else:
            stdout = subprocess.DEVNULL if silent else None
            result = subprocess.run(
                cmd if isinstance(cmd, list) else cmd.split(),
                shell=isinstance(cmd, str),
                cwd=cwd,
                env=env,
                stdout=stdout,
                stderr=subprocess.STDOUT if silent else None,
                check=True
            )
            return result
    except subprocess.CalledProcessError as e:
        if not silent:
            print(Style.error(f"Command xatolik: {e}"))
        return None

def check_url(url, timeout=5):
    """URL mavjudligini tekshirish"""
    try:
        import urllib.request
        urllib.request.urlopen(url, timeout=timeout)
        return True
    except:
        return False

def is_process_running(pid):
    """Process ishlayotganini tekshirish"""
    try:
        if platform.system() == 'Windows':
            result = subprocess.run(['tasklist', '/FI', f'PID eq {pid}'], 
                                  capture_output=True, text=True)
            return str(pid) in result.stdout
        else:
            subprocess.run(['kill', '-0', str(pid)], 
                         stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL, check=True)
            return True
    except:
        return False

def kill_process(pid, force=False):
    """Processni to'xtatish"""
    try:
        if platform.system() == 'Windows':
            subprocess.run(['taskkill', '/F' if force else '', '/PID', str(pid)], 
                         stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        else:
            subprocess.run(['kill', '-9' if force else '', str(pid)], 
                         stdout=subprocess.DEVNULL, stderr=subprocess.DEVNULL)
        return True
    except:
        return False

def save_pid(pid, name, logs_dir):
    """PID ni saqlash"""
    pid_file = logs_dir / f"{name}.pid"
    with open(pid_file, 'w') as f:
        f.write(str(pid))
    return pid_file

def load_pid(name, logs_dir):
    """PID ni yuklash"""
    pid_file = logs_dir / f"{name}.pid"
    if pid_file.exists():
        with open(pid_file, 'r') as f:
            return int(f.read().strip())
    return None

def delete_pid(name, logs_dir):
    """PID faylini o'chirish"""
    pid_file = logs_dir / f"{name}.pid"
    if pid_file.exists():
        pid_file.unlink()

# ============================================================================
# MAIN FUNCTIONS
# ============================================================================

class SmartPOSManager:
    """SmartPOS CRM Manager"""
    
    def __init__(self, script_dir):
        self.script_dir = Path(script_dir).absolute()
        self.backend_dir = self.script_dir / 'backend'
        self.frontend_dir = self.script_dir / 'frontend'
        self.logs_dir = self.script_dir / 'logs'
        self.logs_dir.mkdir(exist_ok=True)
        
        # Platform
        self.is_windows = platform.system() == 'Windows'
        
        # Paths
        if self.is_windows:
            self.venv_python = self.backend_dir / 'venv' / 'Scripts' / 'python.exe'
            self.venv_pip = self.backend_dir / 'venv' / 'Scripts' / 'pip.exe'
            self.venv_uvicorn = self.backend_dir / 'venv' / 'Scripts' / 'uvicorn.exe'
            self.venv_alembic = self.backend_dir / 'venv' / 'Scripts' / 'alembic.exe'
        else:
            self.venv_python = self.backend_dir / 'venv' / 'bin' / 'python'
            self.venv_pip = self.backend_dir / 'venv' / 'bin' / 'pip'
            self.venv_uvicorn = self.backend_dir / 'venv' / 'bin' / 'uvicorn'
            self.venv_alembic = self.backend_dir / 'venv' / 'bin' / 'alembic'
    
    def check_requirements(self):
        """Barcha talablar tekshirish"""
        print_banner("ğŸ“‹ Talablar Tekshiruvi", Colors.CYAN)
        
        requirements_met = True
        
        print(Style.step("Python tekshirilmoqda..."))
        if not check_command('python3' if not self.is_windows else 'python', 'Python'):
            requirements_met = False
        
        print(Style.step("Node.js tekshirilmoqda..."))
        if not check_command('node', 'Node.js'):
            requirements_met = False
        
        print(Style.step("npm tekshirilmoqda..."))
        if not check_command('npm', 'npm'):
            requirements_met = False
        
        if requirements_met:
            print(f"\n{Style.success('Barcha talablar bajarildi!')}\n")
        else:
            print(f"\n{Style.error('Ba\'zi talablar bajarilmadi!')}\n")
        
        return requirements_met
    
    def setup_backend(self):
        """Backend setup"""
        print_banner("ğŸ”§ Backend Sozlash", Colors.BLUE)
        
        # Virtual environment
        venv_dir = self.backend_dir / 'venv'
        if not venv_dir.exists():
            print(Style.step("Virtual environment yaratilmoqda..."))
            cmd = f'python3 -m venv venv' if not self.is_windows else 'python -m venv venv'
            run_command(cmd, cwd=self.backend_dir, silent=True)
            print(Style.success("Virtual environment yaratildi"))
        else:
            print(Style.success("Virtual environment mavjud"))
        
        # Dependencies
        if not (self.backend_dir / 'requirements.txt').exists():
            print(Style.error("requirements.txt topilmadi!"))
            return False
        
        print(Style.step("Dependencies o'rnatilmoqda/yangilanmoqda..."))
        run_command(f'{self.venv_pip} install --quiet --upgrade pip', silent=True)
        run_command(f'{self.venv_pip} install --quiet -r requirements.txt', 
                   cwd=self.backend_dir, silent=True)
        print(Style.success("Backend dependencies tayyor"))
        
        # Migration
        if self.venv_alembic.exists():
            print(Style.step("Database migrationlari bajarilmoqda..."))
            result = run_command(f'{self.venv_alembic} upgrade head', 
                               cwd=self.backend_dir, silent=True)
            if result and result.returncode == 0:
                print(Style.success("Migrationlar muvaffaqiyatli"))
            else:
                print(Style.warning("Migration xatolik (ehtimol database ulangan emas)"))
        else:
            print(Style.warning("Alembic topilmadi"))
        
        return True
    
    def setup_frontend(self):
        """Frontend setup"""
        print_banner("ğŸ¨ Frontend Sozlash", Colors.MAGENTA)
        
        node_modules = self.frontend_dir / 'node_modules'
        
        if not node_modules.exists():
            print(Style.step("node_modules o'rnatilmoqda..."))
            run_command('npm install', cwd=self.frontend_dir, silent=True)
            print(Style.success("Frontend dependencies o'rnatildi"))
        else:
            print(Style.step("node_modules yangilanmoqda..."))
            run_command('npm install --silent', cwd=self.frontend_dir, silent=True)
            print(Style.success("Frontend dependencies tayyor"))
        
        return True
    
    def start_backend(self):
        """Backendni ishga tushirish"""
        print_banner("ğŸš€ Backend Ishga Tushirilmoqda", Colors.GREEN)
        
        # Environment variables
        env = os.environ.copy()
        env.update({
            'DATABASE_URL': env.get('DATABASE_URL', ''),
            'SECRET_KEY': env.get('SECRET_KEY', 'smartpos-secret-key-change-in-production'),
            'AZURE_OPENAI_ENDPOINT': env.get('AZURE_OPENAI_ENDPOINT', ''),
            'AZURE_OPENAI_API_KEY': env.get('AZURE_OPENAI_API_KEY', ''),
            'AZURE_OPENAI_DEPLOYMENT_NAME': env.get('AZURE_OPENAI_DEPLOYMENT_NAME', 'gpt-4o'),
            'AZURE_OPENAI_API_VERSION': env.get('AZURE_OPENAI_API_VERSION', '2024-02-15-preview'),
        })
        
        backend_log = self.logs_dir / 'backend.log'
        cmd = [str(self.venv_uvicorn), 'app.main:app', '--host', '0.0.0.0', '--port', '8000', '--reload']
        
        print(Style.step("Backend server ishga tushirilmoqda..."))
        process = run_command(cmd, cwd=self.backend_dir, background=True, 
                             log_file=backend_log, silent=True, env=env)
        
        if process:
            save_pid(process.pid, 'backend', self.logs_dir)
            print(Style.success(f"Backend ishga tushdi (PID: {process.pid})"))
            
            # Health check
            print(Style.step("Health check (5 soniya kutish)..."))
            time.sleep(5)
            
            if check_url('http://localhost:8000/health'):
                print(Style.success("Backend muvaffaqiyatli ishga tushdi!"))
                return True
            else:
                print(Style.warning("Backend ishga tushdi, lekin health check muvaffaqiyatsiz"))
                print(Style.info(f"Loglarni tekshiring: {backend_log}"))
                return True
        else:
            print(Style.error("Backendni ishga tushirishda xatolik!"))
            return False
    
    def start_frontend(self):
        """Frontendni ishga tushirish"""
        print_banner("ğŸ¨ Frontend Ishga Tushirilmoqda", Colors.MAGENTA)
        
        frontend_log = self.logs_dir / 'frontend.log'
        cmd = ['npm', 'run', 'dev', '--', '--host', '0.0.0.0', '--port', '5173']
        
        print(Style.step("Frontend server ishga tushirilmoqda..."))
        process = run_command(cmd, cwd=self.frontend_dir, background=True, 
                             log_file=frontend_log, silent=True)
        
        if process:
            save_pid(process.pid, 'frontend', self.logs_dir)
            print(Style.success(f"Frontend ishga tushdi (PID: {process.pid})"))
            
            # Check
            print(Style.step("Frontend tekshirilmoqda (3 soniya kutish)..."))
            time.sleep(3)
            
            if check_url('http://localhost:5173'):
                print(Style.success("Frontend muvaffaqiyatli ishga tushdi!"))
                return True
            else:
                print(Style.warning("Frontend ishga tushdi, lekin tekshirish muvaffaqiyatsiz"))
                print(Style.info(f"Loglarni tekshiring: {frontend_log}"))
                return True
        else:
            print(Style.error("Frontendni ishga tushirishda xatolik!"))
            return False
    
    def stop_backend(self):
        """Backendni to'xtatish"""
        print_banner("ğŸ›‘ Backend To'xtatilmoqda", Colors.YELLOW)
        
        pid = load_pid('backend', self.logs_dir)
        
        if pid and is_process_running(pid):
            print(Style.step(f"Backend to'xtatilmoqda (PID: {pid})..."))
            kill_process(pid)
            time.sleep(1)
            if is_process_running(pid):
                kill_process(pid, force=True)
            print(Style.success("Backend to'xtatildi"))
            delete_pid('backend', self.logs_dir)
        else:
            print(Style.info("Backend process topilmadi, qidirilmoqda..."))
            if self.is_windows:
                run_command('taskkill /F /IM uvicorn.exe', silent=True)
            else:
                run_command('pkill -f "uvicorn.*app.main:app"', silent=True)
            print(Style.success("Backend processlari to'xtatildi"))
    
    def stop_frontend(self):
        """Frontendni to'xtatish"""
        print_banner("ğŸ›‘ Frontend To'xtatilmoqda", Colors.YELLOW)
        
        pid = load_pid('frontend', self.logs_dir)
        
        if pid and is_process_running(pid):
            print(Style.step(f"Frontend to'xtatilmoqda (PID: {pid})..."))
            kill_process(pid)
            time.sleep(1)
            if is_process_running(pid):
                kill_process(pid, force=True)
            print(Style.success("Frontend to'xtatildi"))
            delete_pid('frontend', self.logs_dir)
        else:
            print(Style.info("Frontend process topilmadi, qidirilmoqda..."))
            if self.is_windows:
                run_command('taskkill /F /IM node.exe', silent=True)
            else:
                run_command('pkill -f "vite.*--port 5173"', silent=True)
            print(Style.success("Frontend processlari to'xtatildi"))
    
    def status(self):
        """Status ko'rsatish"""
        print_banner("ğŸ“Š Servislar Statusi", Colors.CYAN)
        
        backend_pid = load_pid('backend', self.logs_dir)
        frontend_pid = load_pid('frontend', self.logs_dir)
        
        # Backend status
        if backend_pid and is_process_running(backend_pid):
            backend_status = f"{Colors.GREEN}â— Ishlamoqda{Colors.RESET} (PID: {backend_pid})"
            backend_url = f"{Colors.GREEN}http://localhost:8000{Colors.RESET}"
        else:
            backend_status = f"{Colors.RED}â— To'xtatilgan{Colors.RESET}"
            backend_url = f"{Colors.RED}N/A{Colors.RESET}"
        
        # Frontend status
        if frontend_pid and is_process_running(frontend_pid):
            frontend_status = f"{Colors.GREEN}â— Ishlamoqda{Colors.RESET} (PID: {frontend_pid})"
            frontend_url = f"{Colors.GREEN}http://localhost:5173{Colors.RESET}"
        else:
            frontend_status = f"{Colors.RED}â— To'xtatilgan{Colors.RESET}"
            frontend_url = f"{Colors.RED}N/A{Colors.RESET}"
        
        status_box = f"""
{Colors.CYAN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—{Colors.RESET}
{Colors.CYAN}â•‘{Colors.RESET}  Backend:  {backend_status:50} {Colors.CYAN}â•‘{Colors.RESET}
{Colors.CYAN}â•‘{Colors.RESET}  URL:      {backend_url:50} {Colors.CYAN}â•‘{Colors.RESET}
{Colors.CYAN}â•‘{Colors.RESET}                                                                  {Colors.CYAN}â•‘{Colors.RESET}
{Colors.CYAN}â•‘{Colors.RESET}  Frontend: {frontend_status:50} {Colors.CYAN}â•‘{Colors.RESET}
{Colors.CYAN}â•‘{Colors.RESET}  URL:      {frontend_url:50} {Colors.CYAN}â•‘{Colors.RESET}
{Colors.CYAN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•{Colors.RESET}
"""
        print(status_box)
        
        # URLs
        print(f"\n{Colors.BOLD}ğŸ“Œ Foydali Linklar:{Colors.RESET}")
        print(f"   {Colors.CYAN}Backend API:{Colors.RESET}  http://localhost:8000")
        print(f"   {Colors.CYAN}Frontend:{Colors.RESET}     http://localhost:5173")
        print(f"   {Colors.CYAN}API Docs:{Colors.RESET}      http://localhost:8000/docs")
        print(f"   {Colors.CYAN}Health:{Colors.RESET}        http://localhost:8000/health")
    
    def logs(self, service=None, lines=50):
        """Loglarni ko'rsatish"""
        print_banner("ğŸ“ Loglar", Colors.CYAN)
        
        if service == 'backend' or service is None:
            backend_log = self.logs_dir / 'backend.log'
            if backend_log.exists():
                print(f"\n{Colors.BOLD}Backend Logs (oxirgi {lines} qator):{Colors.RESET}")
                print(f"{Colors.CYAN}{'â”€' * 70}{Colors.RESET}")
                try:
                    with open(backend_log, 'r') as f:
                        log_lines = f.readlines()
                        for line in log_lines[-lines:]:
                            print(line.rstrip())
                except Exception as e:
                    print(Style.error(f"Log o'qishda xatolik: {e}"))
                print(f"{Colors.CYAN}{'â”€' * 70}{Colors.RESET}\n")
        
        if service == 'frontend' or service is None:
            frontend_log = self.logs_dir / 'frontend.log'
            if frontend_log.exists():
                print(f"\n{Colors.BOLD}Frontend Logs (oxirgi {lines} qator):{Colors.RESET}")
                print(f"{Colors.CYAN}{'â”€' * 70}{Colors.RESET}")
                try:
                    with open(frontend_log, 'r') as f:
                        log_lines = f.readlines()
                        for line in log_lines[-lines:]:
                            print(line.rstrip())
                except Exception as e:
                    print(Style.error(f"Log o'qishda xatolik: {e}"))
                print(f"{Colors.CYAN}{'â”€' * 70}{Colors.RESET}\n")

# ============================================================================
# COMMAND HANDLERS
# ============================================================================

def cmd_start(manager, args):
    """Start command"""
    print_logo()
    
    # Requirements check
    if not manager.check_requirements():
        print(f"\n{Style.error('Talablar bajarilmadi! Iltimos, kerakli dasturlarni o\'rnating.')}\n")
        sys.exit(1)
    
    # Setup
    if not manager.setup_backend():
        sys.exit(1)
    
    if not manager.setup_frontend():
        sys.exit(1)
    
    # Stop old processes
    print_banner("ğŸ§¹ Eski Processlar Tozalash", Colors.YELLOW)
    manager.stop_backend()
    manager.stop_frontend()
    time.sleep(2)
    
    # Start services
    backend_ok = manager.start_backend()
    frontend_ok = manager.start_frontend()
    
    # Final message
    print(f"\n{Colors.GREEN}{Colors.BOLD}{'â•' * 70}")
    print(f"{'âœ… SmartPOS CRM muvaffaqiyatli ishga tushdi!'.center(70)}")
    print(f"{'â•' * 70}{Colors.RESET}\n")
    
    print(f"{Colors.BOLD}ğŸ“Š Servislar:{Colors.RESET}")
    print(f"   {Colors.GREEN}Backend:{Colors.RESET}  http://localhost:8000")
    print(f"   {Colors.GREEN}Frontend:{Colors.RESET} http://localhost:5173")
    print(f"   {Colors.GREEN}API Docs:{Colors.RESET} http://localhost:8000/docs\n")
    
    print(f"{Colors.BOLD}ğŸ“ Loglar:{Colors.RESET}")
    print(f"   Backend:  {Colors.YELLOW}logs/backend.log{Colors.RESET}")
    print(f"   Frontend: {Colors.YELLOW}logs/frontend.log{Colors.RESET}\n")
    
    print(f"{Colors.BOLD}ğŸ›‘ To'xtatish:{Colors.RESET}")
    print(f"   {Colors.YELLOW}./smartpos stop{Colors.RESET} yoki {Colors.YELLOW}python3 smartpos stop{Colors.RESET}\n")
    
    print(f"{Colors.YELLOW}âš ï¸  Eslatma: Bu terminalni yopmasangiz, servislar ishlashda davom etadi.{Colors.RESET}\n")
    
    # Signal handler
    def signal_handler(sig, frame):
        print(f"\n{Style.warning('To\'xtatilmoqda...')}")
        manager.stop_backend()
        manager.stop_frontend()
        sys.exit(0)
    
    signal.signal(signal.SIGINT, signal_handler)
    signal.signal(signal.SIGTERM, signal_handler)
    
    # Keep running
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        signal_handler(None, None)

def cmd_stop(manager, args):
    """Stop command"""
    print_logo()
    manager.stop_backend()
    manager.stop_frontend()
    print(f"\n{Style.success('Barcha servislar to\'xtatildi!')}\n")

def cmd_status(manager, args):
    """Status command"""
    print_logo()
    manager.status()
    print()

def cmd_logs(manager, args):
    """Logs command"""
    print_logo()
    manager.logs(args.service, args.lines)

def cmd_restart(manager, args):
    """Restart command"""
    print_logo()
    print_banner("ğŸ”„ Qayta Ishga Tushirish", Colors.CYAN)
    manager.stop_backend()
    manager.stop_frontend()
    time.sleep(2)
    manager.start_backend()
    manager.start_frontend()
    print(f"\n{Style.success('Barcha servislar qayta ishga tushirildi!')}\n")

# ============================================================================
# MAIN
# ============================================================================

def main():
    """Main function"""
    parser = argparse.ArgumentParser(
        description='SmartPOS CRM Professional CLI Tool',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  ./smartpos start          # Ishga tushirish
  ./smartpos stop           # To'xtatish
  ./smartpos status         # Status ko'rsatish
  ./smartpos logs           # Loglarni ko'rsatish
  ./smartpos logs backend   # Faqat backend loglari
  ./smartpos restart        # Qayta ishga tushirish
        """
    )
    
    subparsers = parser.add_subparsers(dest='command', help='Commands')
    
    # Start command
    subparsers.add_parser('start', help='Ishga tushirish')
    
    # Stop command
    subparsers.add_parser('stop', help='To\'xtatish')
    
    # Status command
    subparsers.add_parser('status', help='Status ko\'rsatish')
    
    # Logs command
    logs_parser = subparsers.add_parser('logs', help='Loglarni ko\'rsatish')
    logs_parser.add_argument('service', nargs='?', choices=['backend', 'frontend'],
                            help='Service nomi (backend yoki frontend)')
    logs_parser.add_argument('-n', '--lines', type=int, default=50,
                            help='Ko\'rsatiladigan qatorlar soni (default: 50)')
    
    # Restart command
    subparsers.add_parser('restart', help='Qayta ishga tushirish')
    
    args = parser.parse_args()
    
    if not args.command:
        parser.print_help()
        print_logo()
        print(f"\n{Style.info('Iltimos, command kiriting. Masalan: ./smartpos start')}\n")
        sys.exit(1)
    
    # Manager
    script_dir = Path(__file__).parent.absolute()
    manager = SmartPOSManager(script_dir)
    
    # Command handlers
    handlers = {
        'start': cmd_start,
        'stop': cmd_stop,
        'status': cmd_status,
        'logs': cmd_logs,
        'restart': cmd_restart,
    }
    
    handler = handlers.get(args.command)
    if handler:
        handler(manager, args)
    else:
        parser.print_help()
        sys.exit(1)

if __name__ == '__main__':
    main()


